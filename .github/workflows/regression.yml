name: Regression Tests

on: [workflow_dispatch, push]

# .github/workflows/ci.yaml
permissions: # least-privilege principle
  contents: read # widen only if you need more
  pull-requests: write

jobs:
  regression:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - config: config_samples/ethereum/mainnet/tw/tw_config.json
            hardhat: hardhat_configs/mainnet_hardhat_config.ts
            network: mainnet
            flags: ""
          - config: config_samples/ethereum/mainnet/tw/tw_easy_track_config.json
            hardhat: hardhat_configs/mainnet_hardhat_config.ts
            network: mainnet
            flags: ""
          - config: config_samples/ethereum/hoodi/vaults/hoodi_vaults_testnet_config.json
            hardhat: hardhat_configs/hoodi_hardhat_config.ts
            network: hoodi
            flags: "--allow-source-diff 0x95F00b016bB31b7182D96D25074684518246E42a --allow-bytecode-diff 0x7E99eE3C66636DE415D2d7C880938F2f40f94De4 --allow-bytecode-diff 0x2F0303F20E0795E6CCd17BD5efE791A586f28E03 --allow-bytecode-diff 0x6d1a9bBFF97f7565e9532FEB7b499982848E5e07 --allow-bytecode-diff 0x7b2B6EA1e53B2039a493cA587805183883Cb8B88"
          - config: config_samples/ethereum/hoodi/vaults/hoodi_vaults_easy_track_config.json
            hardhat: hardhat_configs/hoodi_hardhat_config.ts
            network: hoodi
            flags: ""
    env:
      ETHERSCAN_EXPLORER_TOKEN: ${{ secrets.ETHERSCAN_EXPLORER_TOKEN }}
      GITHUB_API_TOKEN: ${{ github.token }}
      LOCAL_RPC_URL: "http://127.0.0.1:7545"
      REMOTE_RPC_URL: ${{ matrix.network == 'mainnet' && secrets['REMOTE_RPC_URL_MAINNET'] || secrets['REMOTE_RPC_URL_HOODI'] }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install Poetry
        run: |
          pip install poetry~=2.2
      - name: Install dependencies
        run: |
          poetry install --no-interaction
          npm ci

      - name: Restore diffyscan caches
        uses: actions/cache@v4
        with:
          path: .diffyscan_cache
          key: diffyscan-cache-${{ matrix.config }}-${{ github.run_id }}
          restore-keys: |
            diffyscan-cache-${{ matrix.config }}-
            diffyscan-cache-

      - name: Run unit tests
        run: |
          poetry run pytest -q

      - name: Run diffyscan
        run: |
          poetry run diffyscan --hardhat-path ${{ matrix.hardhat }} -Y -E -G ${{ matrix.flags }} ${{ matrix.config }}
